<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Progress Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="top-buttons-fixed-left">
        <a href="{{ url_for('class_details_student', class_id=class_id, student_id=student_id) }}" class="button">Back to Class</a>
    </div>

    <!-- Help Button: fixed right center -->
    <div id="help-button-fixed" style="position: fixed; top: 20%; right: 10px; transform: translateY(-50%); z-index: 1100;">
        <button type="button"
            onclick="document.getElementById('ai-explain-modal').style.display='flex';"
            style="background: none; border: none; border-radius: 50%; cursor: pointer; padding: 6px;">
            <img src="{{ url_for('static', filename='help_icon.png') }}" alt="Help"
                style="width:54px; height:54px; display:block;">
        </button>
    </div>

    <!-- Help Popup -->
    <div id="ai-explain-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); align-items:center; justify-content:center; z-index:2000;">
        <div style="background:#fff; padding:28px 32px 22px 32px; border-radius:14px; max-width:520px; margin:auto; box-shadow:0 8px 32px rgba(0,0,0,0.18); display:flex; flex-direction:column; align-items:center; position:relative;">
            <span class="close" onclick="document.getElementById('ai-explain-modal').style.display='none';"
                style="position:absolute; right:18px; top:12px; font-size:2em; color:#888; cursor:pointer;">&times;</span>
            <h2 style="margin-top:0; margin-bottom:16px; text-align:center;">Explanation<br>AI Progress Analysis</h2>
            <div style="font-size:1.08em; color:#333; text-align:left;">
                <b>How is this feedback generated?</b>
                <div style="margin-top:8px;">
                    The AI analyzes your last 5 homework results (multiple choice and open questions, including team challenges). It considers your answers, your skill level at the time, and feedback for open questions. Based on this, it tries to recognize progress, recurring mistakes, and gives you motivating, but honest, tips for your next steps.<br><br>
                    All feedback is generated automatically and may not always be 100% correct. If you are unsure or want more feedback, ask your teacher!
                </div>
            </div>
        </div>
    </div>

    <div style="max-width:600px; margin:60px auto 0 auto; background:#f7f7ff; border-radius:14px; box-shadow:0 4px 24px #b3b3e6; padding:32px;">
        <h2>AI Progress Analysis</h2>
        <div style="display:flex; align-items:center; gap:22px; margin-bottom:8px; background:#e3f2fd; border-radius:12px; padding:18px 18px 18px 22px; box-shadow:0 2px 12px rgba(80,80,160,0.10);">
            <div style="font-size:1.09em; color:#222; font-style:italic; text-align:left; flex:1;">
                {% if analysis %}
                    Hi! I have already created an analysis for you from {{ analysis['created_at'][:16].replace('T', ' ') if analysis['created_at'] else '' }}.<br>
                    If you want a new, updated analysis, just click the button below!
                {% else %}
                    Hi! I haven't created an analysis for you yet. Click the button below and I'll analyze your learning progress for you!
                {% endif %}
            </div>
            <img src="{{ url_for('static', filename='ai_sidekick.png') }}" alt="AI Sidekick"
                 style="width:90px; height:90px; border-radius:50%; flex-shrink:0;">
        </div>
        <div style="color:#d32f2f; font-size:0.98em; font-style:normal; font-weight:bold; margin:10px 0 18px 0; background:none; text-align:left;">
            &#9888; Please note: All feedback and analysis is generated by AI and may not always be 100% accurate. If you have questions or want more feedback, feel free to ask your teacher! &#9888;
        </div>
        {% if analysis %}
            <div style="white-space:normal; font-size:1.08em; margin-bottom:24px; text-align:left;">
                {{ analysis_html|safe }}
            </div>
        {% else %}
            <div style="margin-bottom:24px; color:#888; text-align:left;">
                No analysis available yet. Click the button below to generate your first AI analysis!
            </div>
        {% endif %}
        <form id="ai-analysis-form" method="post" action="{{ url_for('generate_ai_progress_analysis', student_id=student_id, class_id=class_id) }}">
            <button type="submit" class="button" style="width:100%; font-size:1.1em; padding:12px; margin-bottom:10px;">Generate New Analysis</button>
        </form>
        <div style="margin-top:18px; color:#888; font-size:0.97em; text-align:center;">
            Only you can see your AI analysis. The analysis is based on your last 5 homeworks.
        </div>
    </div>
    <script>
    // Modal close on background click
    document.addEventListener('mousedown', function(event) {
        const modal = document.getElementById('ai-explain-modal');
        if (modal && modal.style.display === 'flex' && event.target === modal) {
            modal.style.display = 'none';
        }
    });
    // AJAX for analysis generation
    document.getElementById('ai-analysis-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const response = await fetch(form.action, {method: 'POST'});
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Error generating analysis.');
        }