<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Homework (Teacher View)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="top-buttons-fixed-vertical">
        <a href="/class_details_teacher/{{ class_info['id'] }}/{{ teacher_id }}" class="button">Back to Class</a>
        <a href="{{ url_for('edit_homework', homework_id=homework['id'], class_id=class_info['id'], teacher_id=teacher_id) }}" class="button">Edit Homework</a>

        <form action="/delete_homework" method="post" style="display:inline;" onsubmit="return confirm('Do you really want to delete this homework?')">
            <input type="hidden" name="homework_id" value="{{ homework['id'] }}">
            <input type="hidden" name="class_id" value="{{ class_info['id'] }}">
            <input type="hidden" name="teacher_id" value="{{ teacher_id }}">
            <button type="submit" class="submit-button danger no-background">Delete Homework</button>
        </form>
    </div>
    <!-- Help Button: fixed right center, larger, no border -->
    <div id="help-button-fixed" style="position: fixed; top: 10%; right: 10px; transform: translateY(-50%); z-index: 1100;">
        <button type="button"
            onclick="document.getElementById('help-modal').style.display='flex';"
            style="background: none; border: none; border-radius: 50%; cursor: pointer; padding: 6px;">
            <img src="{{ url_for('static', filename='help_icon.png') }}" alt="Help"
                style="width:54px; height:54px; display:block;">
        </button>
    </div>

    <!-- Help Popup -->
    <div id="help-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); align-items:center; justify-content:center; z-index:2000;">
        <div style="background:#fff; padding:28px 32px 22px 32px; border-radius:14px; max-width:540px; margin:auto; box-shadow:0 8px 32px rgba(0,0,0,0.18); display:flex; flex-direction:column; align-items:center; position:relative;">
            <span class="close" onclick="document.getElementById('help-modal').style.display='none';"
                style="position:absolute; right:18px; top:12px; font-size:2em; color:#888; cursor:pointer;">&times;</span>
            <h2 style="margin-top:0; margin-bottom:16px; text-align:center;">
                Explanation<br>Homework (Teacher View)
            </h2>
            <div style="font-size:1.08em; color:#333; text-align:left;">
                <div style="font-weight:bold; margin-top:12px;">Overview</div>
                <ul style="margin-left:22px; margin-bottom:10px;">
                    <li>This page shows all questions and statistics for the selected homework assignment.</li>
                    <li>At the top, you see how many students have completed the homework, broken down by skill level groups.</li>
                </ul>
                {% if questions and questions|length > 0 %}
                    <div style="font-weight:bold; margin-top:12px;">Multiple Choice Questions</div>
                    <ul style="margin-left:22px; margin-bottom:10px;">
                        <li>All multiple choice questions are displayed with their answer options.</li>
                        <li>
                            <b>Skill Level</b> next to each question shows which students (by skill level) received this question.
                        </li>
                        <li>
                            Under each question, you see how many students answered it, and the percentage of correct and incorrect answers.
                        </li>
                        <li>
                            You can use the "Check" button to simulate answering the homework as a student and see the correct answers and explanations.
                        </li>
                    </ul>
                {% endif %}
                {% if open_questions and open_questions|length > 0 %}
                    <div style="font-weight:bold; margin-top:12px;">Open Questions</div>
                    <ul style="margin-left:22px; margin-bottom:10px;">
                        <li>All open-ended questions are displayed with their sample solutions.</li>
                        <li>
                            <b>Skill Level</b> next to each question shows which students (by skill level) received this question.
                        </li>
                        <li>
                            Under each question, you see how many students answered it, and the percentage of correct and incorrect answers.
                        </li>
                        <li>
                            The sample solution is used by the AI to automatically evaluate student answers.
                        </li>
                    </ul>
                {% endif %}
                <div style="font-weight:bold; margin-top:12px;">Actions</div>
                <ul style="margin-left:22px; margin-bottom:10px;">
                    <li>Use <b>Edit Homework</b> to change questions or answers.</li>
                    <li>Use <b>Delete Homework</b> to remove this assignment from the class.</li>
                </ul>
            </div>
        </div>
    </div>
    <div style="max-width:600px;margin:32px auto 24px auto;padding:20px 28px;background:#f5faff;border-radius:14px;box-shadow:0 2px 12px rgba(80,120,200,0.09);text-align:center;">
        <div style="font-size:1.15em;margin-bottom:6px;">
            <b>{{ num_done }}</b> out of <b>{{ total_students }}</b> students have completed this homework.
        </div>
        <div style="font-size:1em;color:#444;">
            <span style="display:inline-block;margin:0 10px;">
                <b>Level 1–3:</b> {{ done_skill_1 }} / {{ total_skill_1 }}
            </span>
            <span style="display:inline-block;margin:0 10px;">
                <b>Level 4–7:</b> {{ done_skill_4 }} / {{ total_skill_4 }}
            </span>
            <span style="display:inline-block;margin:0 10px;">
                <b>Level 8–10:</b> {{ done_skill_8 }} / {{ total_skill_8 }}
            </span>
        </div>
    </div>
    

    {% if questions and questions|length > 0 %}
        <form id="homework-form">
            <h1>{{ homework['title'] }}</h1>
            <p>Created on: {{ homework['date_created'] }}</p>
            <br>
            <ol>
                {% for question in questions %}
                    <li style="margin-bottom:22px;">
                        <div>
                            <strong>{{ question['question'] }}</strong>
                            <br>
                            <em>({{ question['taxonomy'] }} - 
                                {% if question['skill_level'] == 1 %}
                                    Skill Level 1 – 3
                                {% elif question['skill_level'] == 4 %}
                                    Skill Level 4 – 7
                                {% elif question['skill_level'] == 8 %}
                                    Skill Level 8 – 10
                                {% else %}
                                    {{ question['skill_level'] }}
                                {% endif %}
                            )</em>
                        </div>
                        <div style="margin-bottom: 10px; text-align: center;">
                            {% for option in question['options'] %}
                                <div style="margin-bottom: 8px; display: flex; align-items: center; justify-content: center;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="answer_{{ question.index }}" value="{{ option.index }}">
                                        <span>{{ option.option }}</span>
                                    </label>
                                </div>
                            {% endfor %}
                        <span id="result_{{ question.index }}"></span>
                        <!-- STATISTIKEN DIREKT UNTER DER FRAGE -->
                        {% for stat in question_stats %}
                            {% if stat.question_id == question['id'] %}
                                <div style="font-size:0.95em;color:#555;margin:6px 0 0 0;">
                                    {{ stat.answered }} answered |
                                    <span style="color:green;">{{ stat.percent_correct }}% correct</span> /
                                    <span style="color:red;">{{ stat.percent_wrong }}% wrong</span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </li>
                {% endfor %}
            </ol>
            <button type="button" onclick="checkAnswers()">Check</button>
        </form>
    {% elif open_questions and open_questions|length > 0 %}
        <div class="openq-form" style="background-color:#fff; padding: 32px 24px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.08); max-width: 600px; margin: 36px auto;">
            <h2 style="margin-top:0; text-align:center;">Open Questions</h2>
            <div>
                {% for oq in open_questions %}
                    <div style="margin-bottom:32px; text-align:center;">
                        <div style="margin-bottom:8px;">
                            <span style="font-size:1.08em; font-weight:bold;">
                                {{ loop.index }}. {{ oq['question'] }}
                            </span>
                            <br>
                            <span style="font-size:0.98em; color:#666;">
                                <em>({{ oq['taxonomy'] }} -
                                    {% if oq['skill_level'] == 1 %}
                                        Skill Level 1 – 3
                                    {% elif oq['skill_level'] == 4 %}
                                        Skill Level 4 – 7
                                    {% elif oq['skill_level'] == 8 %}
                                        Skill Level 8 – 10
                                    {% else %}
                                        {{ oq['skill_level'] }}
                                    {% endif %}
                                )</em>
                            </span>
                        </div>
                        <details style="margin:10px auto 0 auto; display:inline-block; text-align:left;">
                            <summary style="cursor:pointer;">Show Sample Solution</summary>
                            <div style="margin-top:6px; color:#444;">
                                {{ oq['sample_solution'] }}
                            </div>
                        </details>
                        <!-- STATISTIKEN DIREKT UNTER DER FRAGE -->
                        {% for stat in question_stats %}
                            {% if stat.question_id == oq['id'] %}
                                <div style="font-size:0.95em;color:#555;margin:10px 0 0 0;">
                                    {{ stat.answered }} answered |
                                    <span style="color:green;">{{ stat.percent_correct }}% correct</span> /
                                    <span style="color:red;">{{ stat.percent_wrong }}% wrong</span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <script>
        const correctAnswers = {{ correct_answers | tojson }};
        const explanations = {{ explanations | tojson }};
        const questions = {{ questions | tojson }};

        function checkAnswers() {
            console.log("Check Answers Function Triggered");

            const form = document.getElementById('homework-form');
            const elements = form.elements;
            const checkedAnswers = {};

            for (let el of elements) {
                if (el.type === "radio" && el.checked) {
                    const questionIndex = el.name.split('_')[1];
                    checkedAnswers[questionIndex] = parseInt(el.value, 10);
                }
            }

            console.log("Checked Answers:", checkedAnswers);

            for (let questionIndex in correctAnswers) {
                const resultSpan = document.getElementById('result_' + questionIndex);
                const userAnswer = checkedAnswers[questionIndex];
                const correctAnswer = parseInt(correctAnswers[questionIndex], 10);

                if (userAnswer === undefined) {
                    const correctText = questions[questionIndex].options[correctAnswer]?.option || "Option not found";
                    resultSpan.innerText = `❌ Wrong! No answer selected. Correct answer: ${correctText}. Explanation: ${explanations[questionIndex]}`;
                    resultSpan.classList.add('incorrect');
                    resultSpan.classList.remove('correct');
                } else if (userAnswer === correctAnswer) {
                    resultSpan.innerText = '✔️ Correct!';
                    resultSpan.classList.add('correct');
                    resultSpan.classList.remove('incorrect');
                } else {
                    const correctText = questions[questionIndex].options[correctAnswer]?.option || "Option not found";
                    resultSpan.innerText = `❌ Wrong! Correct answer: ${correctText}. Explanation: ${explanations[questionIndex]}`;
                    resultSpan.classList.add('incorrect');
                    resultSpan.classList.remove('correct');
                }
            }
        }

        document.addEventListener('mousedown', function(event) {
            const modal = document.getElementById('help-modal');
            if (modal && modal.style.display === 'flex' && event.target === modal) {
                modal.style.display = 'none';
            }
        });
    </script>
</body>
</html>